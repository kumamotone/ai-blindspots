
+++
title = "準備的リファクタリング"
slug = "preparatory-refactoring"
date = "2025-03-03T21:24:52-05:00"
tags = []
+++

[Preparatory Refactoring](https://martinfowler.com/articles/preparatory-refactoring-example.html)（準備的リファクタリング）とは、「変更を容易にするためにまずリファクタリングを行い、その後で本命の変更を行う」という手法です。リファクタリングはコードの意味を変えないため、その結果を評価しやすいというメリットがあります。

現在のLLMは、明示的な指示がないと「まずリファクタリングをしてから次のステップへ進む」といった段階的アプローチを自主的に取ってくれるわけではありません。何も言わなければ一度にすべてをやろうとします。また、LLMはしばしば「熱心すぎる新人エンジニア」のように関連性の薄い箇所までどんどん手を入れ、「ボーイスカウト原則（少しでも綺麗にしてから去れ）」を過度に実践しようとすることがあります。レビューの観点では、リファクタリングと本質的変更を同時に行われると、どこが何のための変更か把握しづらくなります。  
そこで、LLMには不要なリファクタリングをしないよう強く指示する（ただしCursor Sonnet 3.7は指示の遵守がそこまで得意ではありませんが）か、もしくはLLMが着手すると見込まれるコードを先にこちらでリファクタリングしておき、後から本命の変更を行わせる、といった運用が考えられます。また「常に型アノテーションを付けろ」といった形でLLMを指導している場合、それが余計なリファクタリングを誘発する場合もあります。LLMにどの範囲のコードを触らせるかを明確化すると改善するかもしれません。

## 例

- インポートエラーを修正してほしいとLLMに依頼したところ、インポート修正だけでなく、未アノテーションのラムダに型をつけるなど関係のないリファクタリングも勝手に行い、しかもその型アノテーションに誤りがあり、以後エージェントループが泥沼化してしまいました。

