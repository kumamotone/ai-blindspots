
+++
title = "3回目の法則"
slug = "rule-of-three"
date = "2025-03-13T14:02:33-04:00"
tags = []
+++

ソフトウェア開発における「3回目の法則」は、同じコードを2回まではコピーしてよいが、3回目に同じ実装をコピーしようとしたら共通化を検討すべき、という考え方です。これは「重複をなくそう（DRY）」の単純適用よりも現実的で、2回目まではまだ抽象化方法が明確ではないことも多いからです（[The Wrong Abstraction](https://sandimetz.com/blog/2016/1/20/the-wrong-abstraction) も参照）。

LLMはコードを重複させるのが大好きです。理由を考えると、LLMは特に指示がない場合、プログラムを変更するよう頼まれると、修正を加えた新しいプログラム全体をそのまま出力してしまうからです。重複を除去するためには、モデルがコードの重複を見つけてそれをリファクタリングする必要がありますが、主体的な思考なしにそれをやるのは難しい面があります（Sonnet 3.7は逆に不要なリファクタリングを積極的にやる傾向もありますが、「Claude Code」のシステムプロンプトを見ると、モデルには余計な修正をしすぎないようにという指示が書かれています）。また、もしコードベースにすでにコピペコードが山ほどあるなら、LLMは「あなたが望んでいるスタイル」だと判断してさらにコピペを増やすかもしれません。重複を無くしたいなら、こちらから明確に指示を出しましょう。

## 例

- ある機能のテストをLLMに書かせたら、たくさんのテストで同じコードが重複しました。ヘルパーメソッドを使ってまとめるようにLLMに明示的に依頼すると、ようやくテストを共通化してくれました。エージェントモードでファイルを分割している場合、新しいテストを書くときにヘルパーがあるファイルを読み込んでくれるかどうかも課題になります。

